{"version":3,"sources":["user.js"],"names":[],"mappings":"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","file":"user-compiled.js","sourcesContent":["// ************************************************************************** //\n//                                                                            //\n//                                                        :::      ::::::::   //\n//   user.js                                            :+:      :+:    :+:   //\n//                                                    +:+ +:+         +:+     //\n//   By: opichou <marvin@42.fr>                     +#+  +:+       +#+        //\n//                                                +#+#+#+#+#+   +#+           //\n//   Created: 2016/09/19 18:27:53 by opichou           #+#    #+#             //\n//   Updated: 2016/09/29 18:27:53 by opichou          ###   ########.fr       //\n//                                                                            //\n// ************************************************************************** //\n\nimport fs from 'fs';\nimport session from 'express-session';\nimport bcrypt from 'bcrypt';\nimport * as dbl from \"./dbConnect\";\nimport credentials from '../credentials';\nimport mongodb from 'mongodb';\nimport jwt from 'jsonwebtoken';\nimport nodemailer from 'nodemailer';\nimport ERROR from './errno_code';\nimport match from '../model/match';\n\nlet saltRounds = 10;\n\nlet transporter = nodemailer.createTransport('smtps://apimatcha@gmail.com:apiMatcha1212@smtp.gmail.com');\n\nfunction now() {\n    const currentdate = new Date();\n    return currentdate.getDay() + \"/\" + currentdate.getMonth() + \"/\" + currentdate.getFullYear() + \" @ \" + currentdate.getHours() + \":\" + currentdate.getMinutes() + \":\" + currentdate.getSeconds();\n}\n\nasync function genToken(user) {\n    let myToken = await jwt.sign({ username: user.login }, credentials.jwtSecret);\n    const db = await dbl.connect();\n    try {\n        const update = await db.collection('users').updateOne({ login: user.login }, { $set: { token: myToken } });\n        if (update.modifiedCount == 1) {\n            user.token = myToken;\n\n            console.log(user.login + \" connected: \" + now());\n            return user;\n        } else {\n            console.error(ERROR.TOKEN_ERROR + user.login);\n            user.success = false;\n            user.message = ERROR.TOKEN_ERROR;\n            return user;\n        }\n    } catch (err) {\n        console.error(err);\n        user.success = false;\n        user.message = ERROR.TOKEN_ERROR;\n        return user;\n    } finally {\n        db.close();\n    }\n}\n\nasync function addFingerprint(user, fingerprint) {\n    let db = await dbl.connect();\n    try {\n        db.collection('users').updateOne({ login: user.login }, { $push: { fingerprint: fingerprint } });\n        user.fingerprint = fingerprint;\n        return user;\n    } catch (err) {\n        console.error(err);\n    }\n}\n\nfunction contains(a, obj) {\n    for (let i = 0; i < a.length; i++) {\n        if (a[i] === obj) {\n            return true;\n        }\n    }\n    return false;\n}\n\nasync function basicAuth(login, password, fingerprint, callback) {\n    let db = await dbl.connect();\n    try {\n        let user = await db.collection('users').findOne({ $or: [{ login: login, active: true }, { email: login, active: true }] });\n        try {\n            db.close();\n            if (!user) {\n                callback({ success: false, message: ERROR.AUTH_ERROR }, {\n                    auth: {\n                        success: false,\n                        message: ERROR.AUTH_ERROR\n                    }\n                });\n            } else {\n                bcrypt.compare(password, user.password, async (err, res) => {\n                    if (res) {\n                        user = await genToken(user);\n                        console.log(\"Token received\");\n                        if (user.fingerprint && contains(user.fingerprint, fingerprint)) {\n                            const ret = {\n                                auth: {\n                                    method: \"basic\",\n                                    success: true,\n                                    fingerprint: fingerprint,\n                                    token: user.token,\n                                    message: ERROR.LOGIN_SUCCESS_INFO\n                                }\n                            };\n                            callback(err, ret);\n                        } else {\n                            console.log(\"New fingerprint will be added to user profile\");\n                            user = addFingerprint(user, fingerprint);\n                            const ret = {\n                                auth: {\n                                    method: \"basic\",\n                                    success: true,\n                                    fingerprint: fingerprint,\n                                    token: user.token,\n                                    message: ERROR.LOGIN_SUCCESS_INFO\n                                }\n                            };\n                            callback(err, ret);\n                        }\n                    } else {\n                        console.log(\"wrong password\");\n                        const ret = {\n                            auth: {\n                                method: \"basic\",\n                                success: false,\n                                fingerprint: fingerprint,\n                                message: ERROR.AUTH_PASSWORD_ERROR\n                            }\n                        };\n                        callback(err, ret);\n                    }\n                });\n            }\n        } catch (err) {\n            callback(err, false);\n        }\n    } catch (err) {\n        console.error(err);\n    }\n}\n\nasync function tokenAuth(token, fingerprint, callback) {\n    let db = await dbl.connect();\n    let login = jwt.verify(token, credentials.jwtSecret).username;\n    console.log(\"token auth for user: \" + login);\n    try {\n        let user = await db.collection('users').findOne({ login: login, active: true });\n        if (!user) {\n            const ret = {\n                auth: {\n                    method: \"token\",\n                    success: false,\n                    fingerprint: fingerprint,\n                    message: ERROR.AUTH_ERROR } };\n            callback(true, ret);\n        } else if (user.fingerprint && contains(user.fingerprint, fingerprint)) {\n            const ret = {\n                auth: {\n                    method: \"token\",\n                    success: true,\n                    fingerprint: fingerprint,\n                    message: ERROR.LOGIN_SUCCESS_INFO } };\n            callback(false, ret);\n        } else {\n            const ret = {\n                auth: {\n                    method: \"token\",\n                    success: true,\n                    fingerprint: false,\n                    message: ERROR.AUTH_DEVICE_ERROR } };\n            callback(true, ret);\n        }\n    } catch (err) {\n        const ret = {\n            auth: {\n                method: \"token\",\n                success: false,\n                fingerprint: fingerprint,\n                message: ERROR.AUTH_ERROR } };\n        callback(err, ret);\n    } finally {\n        db.close();\n    }\n}\n\nexport async function userLogin(req, res) {\n    let token = req.headers.authorization.match(/^Bearer (.*)$/)[1];\n    await authenticate(req.body.login, req.body.password, token, req.body.fingerprint, (err, ret) => {\n        if (err || ret.auth.fingerprint == false) {\n            console.error(err);\n            res.setHeader('Content-Type', 'application/json');\n            res.send(JSON.stringify(ret));\n        } else {\n            res.setHeader('Content-Type', 'application/json');\n            res.send(JSON.stringify(ret));\n        }\n    });\n}\n\nasync function authenticate(login, password, token, fingerprint, callback) {\n    //This method authenticates user using basic strategy (username and password) or token based strategy.\n    //The first strategy uses Bcrypt to hash and salt the password.\n    //The latter uses JWT to validate the token.\n    //In any case, if a token doesn't exist, one is generated upon authentication success.\n    //After authenticating, if the device fingerprint isn't recognized, user will be required to confirm his identity\n    // using email.\n    //This function fires a callback when succeeding, this callback takes two arguments: err: boolean and ret: object\n    // containing every info about the authentication and its eventual success, if such, user info and details about\n    // device fingerprint status.\n\n    console.log(\"Connection attempt from: \" + login + ' (token: ' + token + ')');\n    if (token && fingerprint) {\n        tokenAuth(token, fingerprint, callback);\n    } else if (login && password && fingerprint) {\n        basicAuth(login, password, fingerprint, callback);\n    } else {\n        callback({ message: ERROR.AUTH_ERROR }, { auth: { success: false, message: ERROR.AUTH_ERROR } });\n    }\n}\n\nexport async function checkLogin(req, res, next) {\n    try {\n        let test = await checkLoginHlp(req.params.login);\n        res.setHeader('Content-Type', 'application/json');\n        res.send(JSON.stringify(test));\n    } catch (err) {\n        next(err);\n    }\n}\n\nasync function checkLoginHlp(login) {\n    let db = await dbl.connect();\n    try {\n        const collection = db.collection('users');\n        let userCount = await collection.find({\n            login: login\n        }).limit(1).count();\n        if (userCount == 0 && !/([ ])/.exec(login)) {\n            console.log(\"Login \" + login + \" is valid\");\n            return { valid: true, message: \"Login \" + login + \" is available\", login: login };\n        } else if (/([ ])/.exec(login)) {\n            console.log(\"Login \" + login + \" is not valid\");\n            return { valid: false, message: \"Login \" + login + \" contains whitespace\", login: login };\n        } else {\n            console.log(\"Login \" + login + \" is not valid\");\n            return { valid: false, message: \"Login \" + login + \" isn't available\", login: login };\n        }\n    } finally {\n        db.close();\n    }\n    //this method checks if Login already exists in database\n}\n\nasync function checkEmailHlp(email) {\n    let db = await dbl.connect();\n    try {\n        let collection = db.collection('users');\n        console.log(collection);\n        let userCount = await collection.find({\n            email: email\n        }).limit(1).count();\n        if (userCount == 0 && email.match(/^[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/ig)) {\n            console.log(\"Email \" + email + \" is valid\");\n            return { valid: true, message: \"Email \" + email + \" is available\", email: email };\n        } else if (userCount == 0) {\n            console.log(\"Email \" + email + \" is not valid\");\n            return { valid: false, error: 1, message: \"Email \" + email + \" is incorrect\", email: email };\n        } else {\n            console.log(\"Email \" + email + \" is not valid\");\n            return { valid: false, error: 2, message: \"A profile already exists for \" + email, email: email };\n        }\n    } finally {\n        db.close();\n    }\n    //this method checks if Email already exists in database\n}\n\nexport async function checkEmail(req, res) {\n    try {\n        let test = await checkEmailHlp(req.params.email);\n        res.setHeader('Content-Type', 'application/json');\n        res.send(JSON.stringify(test));\n    } catch (err) {\n        console.error(err);\n    }\n}\n\nasync function checkPass(pass1, pass2) {\n    if (pass1 === pass2 && pass1.match(/^(?=.*\\d)(?=.*[a-z])(?=.*[A-Z]).{8,48}$/)) {\n        console.log(\"Password \" + pass1 + \" is valid\");\n        let password = await bcrypt.hashSync(pass1, saltRounds);\n        return { valid: true, message: \"Valid password\", password: password };\n    } else {\n        console.log(\"Password \" + pass1 + \" is not valid\");\n        return { valid: false, message: ERROR.PASSWORD_FORMAT_ERROR };\n    }\n}\n\nasync function changePasswordHlp(token, password) {\n    let returnValue = null;\n    await jwt.verify(token, credentials.jwtSecret, async function (err, ret) {\n        console.log(err.message);\n        if (err) {\n            returnValue = { success: false, message: 'token is corrupted' };\n        } else {\n            let password2 = await bcrypt.hashSync(password, saltRounds);\n            const email = ret.email;\n            const db = await dbl.connect();\n            let update = await db.collection('users').updateOne({ email: email }, { $set: { password: password2 } });\n            try {\n                if (update.modifiedCount == 1) {\n                    returnValue = { success: true, message: \"Password updated successfully\" };\n                } else {\n                    returnValue = { success: false, message: \"An error happened while updating the password\" };\n                }\n            } catch (err) {\n                returnValue = { success: false, message: \"Database error\" };\n            } finally {\n                db.close();\n            }\n        }\n    });\n    return returnValue;\n}\n\nexport async function changePassword(req, res) {\n    let token = req.body.token;\n    if (req.body.password === req.body.password2) {\n        const password = req.body.password;\n        let response = await changePasswordHlp(token, password);\n        console.log(response);\n        try {\n            console.log(response);\n            res.setHeader('Content-Type', 'application/json');\n            res.send(response);\n        } catch (err) {\n            console.log(err);\n            console.error(err);\n            res.setHeader('Content-Type', 'application/json');\n            res.send(JSON.stringify(response));\n        }\n    } else {\n        res.setHeader('Content-Type', 'application/json');\n        res.send({ success: false, message: \"Passwords didn't match\" });\n    }\n}\n\nasync function requireNewPassword(email) {\n    //this methods sends an email with a temporary link for the user to create a new password\n    let myToken = jwt.sign({ email: email }, credentials.jwtSecret, { expiresIn: 900 });\n    const db = await dbl.connect();\n    const user = await db.collection('users').findOne({ email: email });\n    try {\n        if (!user || !user.firstName) {\n            return { success: \"false\", message: \"User wasn't found\" };\n        } else {\n            let mailOptions = {\n                from: '\"liveoption\" <customer-success@liveoption.io>', // sender address\n                to: user.email, // list of receivers\n                subject: 'Password reset requested on liveoption',\n                html: '<b>Hello,</b></br><p>A password recovery procedure has been requested ' + 'in your name on liveoption.io. If you requested a new password, please' + ' click on the following link to proceed.</p>' + '<a href=\"http://www.liveoption.io/change_password?token=' + myToken + '\">Change my password now</a>' + '<p>If you didn\\'t request a password reset, please disregard this email</p>' // html body\n            };\n            return await transporter.sendMail(mailOptions);\n        }\n    } catch (err) {\n        console.log(err);\n    } finally {\n        db.close();\n    }\n}\n\nexport async function retrievePassword(req, res) {\n    let email = req.body.email;\n    let response = await requireNewPassword(email, res);\n    try {\n        console.log(response);\n        res.setHeader('Content-Type', 'application/json');\n        res.send(response);\n        console.log(response);\n    } catch (err) {\n        console.error(err);\n    }\n}\n\nexport async function Delete(req, res) {\n    login = req.body.login;\n    password = req.body.password;\n    fingerprint = req.body.fingerprint;\n    let returnValue = null;\n    //this methods allow deletion of a user account after validating password\n    await authenticate(login, password, '', fingerprint, async (err, ret) => {\n        //remove from database and callback to feedback user in the UI\n        if (ret.auth.success) {\n            const db = await dbl.connect();\n            const status = await db.collection('users').updateOne({ login: \"login\" }, { $set: { active: false } });\n            try {\n                returnValue = status;\n            } catch (err) {\n                console.error(err);\n                returnValue = { success: false, state: \"error\", message: ERROR.DELETE_ERROR };\n            } finally {\n                db.close();\n            }\n        } else {\n            retrunValue = { success: false, state: \"error\", message: ERROR.DELETE_ERROR };\n        }\n    });\n    res.setHeader('Content-Type', 'application/json');\n    res.send(JSON.stringify(returnValue));\n}\n\nexport async function renderForm(req, res) {\n    let db = await dbl.connect();\n    let response = await db.collection('profileItems').find();\n    try {\n        res.send(response);\n    } finally {\n        db.close();\n    }\n}\n\nexport async function create(req, res) {\n    let user = {},\n        errors = [],\n        emailProp = await checkEmailHlp(req.body.email),\n        loginProp = await checkLoginHlp(req.body.login),\n        passwordProp = await checkPass(req.body.password, req.body.password2);\n\n    if (emailProp.valid) {\n        user.email = emailProp.email;\n    } else errors.push(emailProp.message) && console.log(\"email error logged\");\n    if (loginProp.valid) {\n        user.login = loginProp.login;\n    } else errors.push(loginProp.message) && console.log(\"login error logged\");\n    if (passwordProp.valid) {\n        user.password = passwordProp.password;\n    } else errors.push(passwordProp.message) && console.log(\"password error logged\");\n    if (errors.length == 0) {\n        let db = await dbl.connect();\n        await db.collection('users').insertOne(user);\n        try {\n            console.log(\"success\");\n        } finally {\n            db.close();\n        }\n        await validateAccount(email);\n        res.send({ success: true, message: \"User created, please check your emails\" });\n    } else {\n        res.send({ success: false, message: \"Your account couldn't be created\", errors: errors });\n    }\n} //this method adds a new user to the database\n\nexport async function reactivate(req, res) {\n    let login = req.body.login,\n        password = req.body.password,\n        db = await dbl.connect();\n    try {\n\n        const user = await db.collection('users').findOneAndUpdate({ login: login, password: password, active: false }, { $set: { active: true } });\n        console.log(user);\n        if (user.nModified != 1) {\n            console.log(\"error\");\n            res.send({ success: false, message: ERROR.REACTIVATION_ERROR });\n        } else {\n            let myToken = jwt.sign({ email: user.email }, credentials.jwtSecret, { expiresIn: 9000 }),\n                mailOptions = {\n                from: '\"liveoption\" <customer-success@liveoption.io>', // sender address\n                to: user.email, // list of receivers\n                subject: 'Your account has been reactivated',\n                html: '<b>Hello,</b></br><p>Your liveoption account has just been reactivated.' + 'If you did not request the reactivation of your liveoption account, <a href=\"' + req.get('host') + '/\">please click here.</a></p>' + '<p>Thank you,</p><p>See you soon !</p>'\n            }; // html body\n            res.send((await transporter.sendMail(mailOptions)));\n        }\n    } finally {\n        db.close();\n    }\n} //this method reactivates a previously desactivated account\n\nasync function validateAccount(email) {\n    let myToken = jwt.sign({ email: email }, credentials.jwtSecret, { expiresIn: 900 });\n    let mailOptions = {\n        from: '\"liveoption\" <customer-success@liveoption.io>', // sender address\n        to: email, // list of receivers\n        subject: 'Pleasee verify your liveoption account',\n        html: '<b>Hello,</b></br><p>You just created a liveoption account. Please click the following link within the next 15mins. to verify your email address.</p>' + '<a href=\"http://www.liveoption.io/account/validate?token=' + myToken + '\">Validate account now</a>' + '<p>Thank you for registering liveoption,</p><p>See you soon !</p>' // html body\n    };\n    return await transporter.sendMail(mailOptions);\n}\n\nexport async function isVerified(res, req) {\n    //this method makes sure the user has authorized his account via email\n    let email = req.user.email;\n    let db = await dbl.connect();\n    try {\n        db.collection('users').updateOne({ email: email }, { $set: { active: true } });\n    } finally {\n        db.close();\n    }\n    res.json({ success: true, message: ERROR.ACCOUNT_VALIDATED_INFO });\n}\n\nexport async function updateProfile(req, res) {\n    let db = await dbl.connect();\n    try {\n        let payload = req.body;\n        let login = req.user.username;\n        addTag(payload.tags);\n        delete payload.tags;\n        await db.collection('users').updateOne({ login: login }, { $set: payload });\n        res.send({ success: true, message: ERROR.PROFILE_UPDATED_INFO });\n    } finally {\n        db.close();\n    }\n}\n\nexport async function tags(req, res) {\n    let db = await dbl.connect();\n    let response = await db.colletion('tags').find().sort({ count: desc });\n    res.send({ response });\n}\n\nexport async function addTag(tags) {\n    if ((await tags) === '') {\n        console.log({ status: \"ok\", tagsCreated: 0 });\n    }\n    const db = await dbl.connect();\n    try {\n        let bulk = await db.collection('tags').initializeUnorderedBulkOp();\n        await req.body.tags.filter(n => n != '').forEach(async n => {\n            bulk.find({ label: n }).upsert().updateOne({ $inc: { count: 1 } });\n        });\n        const result = await bulk.execute({ w: 1 });\n        console.error(result);\n    } finally {\n        db.close();\n    }\n}\n\nexport async function viewAll(res, req) {\n    res.send({ message: \"OK\" });\n}"]}