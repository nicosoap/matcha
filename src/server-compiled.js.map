{"version":3,"sources":["server.js"],"names":[],"mappings":"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","file":"server-compiled.js","sourcesContent":["// ************************************************************************** //\n//                                                                            //\n//                                                        :::      ::::::::   //\n//   server.js                                          :+:      :+:    :+:   //\n//                                                    +:+ +:+         +:+     //\n//   By: opichou <opichou@student.42.fr>            +#+  +:+       +#+        //\n//                                                +#+#+#+#+#+   +#+           //\n//   Created: 2016/09/01 18:27:53 by opichou           #+#    #+#             //\n//   Updated: 2016/09/29 18:27:53 by opichou          ###   ########.fr       //\n//                                                                            //\n// ************************************************************************** //\n\nimport express from 'express'\nimport bodyParser from 'body-parser'\nimport session from 'express-session'\nimport * as user from './controllers/user'\nimport * as tags from './controllers/tags'\nimport * as picture from './controllers/picture'\n// import * as interactions from './controllers/interactions'\nimport * as admin from './controllers/admin'\nimport credentials from './credentials'\nimport expressJWT from 'express-jwt'\nimport multer from 'multer'\nimport socketIo from 'socket.io'\nimport http from 'http'\nimport socketioJwt from 'socketio-jwt'\nimport config from './config.json'\nimport redis from 'socket.io-redis'\nimport cors from 'cors'\n\nlet corsOptions = {\n    origin: 'http://localhost:3000',\n    optionsSuccessStatus: 200 // some legacy browsers (IE11, various SmartTVs) choke on 204\n}\n\nconst app = require('express')();\nconst server = http.createServer(app)\nconst io = socketIo(server)\n// io.adapter(redis({ host: 'localhost', port: 3001 }))\nconst interactions =  require('./controllers/interactions')(io)\nconst upload = multer({ dest: `${__dirname}/public/images` })\n\napp.disable('x-powered-by')\napp.use(cors())\napp.use(require('cookie-parser')(credentials.cookieSecret))\napp.use(session({\n    resave: false,\n    saveUninitialized: true,\n    secret: credentials.cookieSecret,\n}))\napp.set('port', process.env.PORT || config.port || 3001)\napp.use('/images', express.static(__dirname + '/public/images'))\napp.use(bodyParser.json())\napp.use(bodyParser.urlencoded({\n    extended: true\n}))\n\napp.use(expressJWT({secret: credentials.jwtSecret}).unless({\n    path: ['/login',\n        '/retrieve_password',\n        '/activate_account',\n        '/user/new',\n        '/protected',\n        '/public',\n        /^\\/admin\\/userform/i,\n        /^\\/images\\//i,\n        /^\\/test/i]}))\n\nio.use(socketioJwt.authorize({\n    secret: credentials.jwtSecret,\n    handshake: true\n}));\n\n//--ROUTES--/ />\n\napp.get('/', (req, res) => {\n    res.send(\"Welcome dude !!!\");\n})\napp.get('/login', (_, res) => res.send(\"Login Page\"))\napp.post('/login', user.userLogin)\napp.get('/user', cors(corsOptions), user.viewAll)\napp.get('/user/:userId', cors(corsOptions), user.viewOne)\napp.put('/user', user.updateProfile)\napp.post('/image', cors(corsOptions), upload.single('picture'), picture.uploadPicture)\napp.post('/image/delete', picture.deleteOne)\napp.post('/user/new', user.create)\napp.post('/user/update', user.updateProfile)\napp.get('/tags', tags.tags)\napp.post('/tags', tags.addTag)\napp.get('/test/login/:login', user.checkLogin)\napp.get('/test/email/:email', user.checkEmail)\napp.get('/account/register', user.renderForm)\napp.post('/account/change_password', user.changePassword)\napp.post('/account/retrieve_password', user.retrievePassword)\napp.post('/account/activate', user.isVerified)\napp.post('/account/reactivate', user.reactivate)\napp.post('/account/delete', user.Delete)\napp.post('/admin/form/',cors(corsOptions), admin.addFormItems)\napp.get('/admin/userform', cors(corsOptions), admin.getUserForm)\napp.get('/admin/appConfig', cors(corsOptions), admin.getAppConfig)\napp.get('/like/:userId', cors(corsOptions), interactions.like)\napp.get('/dislike/:userId', cors(corsOptions), interactions.dislike)\napp.get('/block/:userId', cors(corsOptions), interactions.block)\n//--ROUTES--/ />\n\nfunction now(){\n    const currentDate = new Date();\n    return currentDate.getDate() + \"/\"+ (\"0\" + (currentDate.getMonth() + 1)).slice(-2)\n        + \"/\" + currentDate.getFullYear() + \" @ \"\n        + currentDate.getHours() + \":\"\n        + currentDate.getMinutes() + \":\" + currentDate.getSeconds()\n}\n\nio.on('connection', socket => {\n    interactions.connect(socket.decoded_token.username, socket.id)\n    console.log(socket.decoded_token.username, 'connected on', now());\n    socket.on('message', body => {\n        socket.emit('message', {\n            body,\n            from: socket.decoded_token.username,\n            read: false\n        })\n    });\n    socket.on('like', body => {\n        socket.broadcast.emit('like', {\n            body,\n            from: socket.decoded_token.username,\n            read: false\n        })\n    });\n    socket.on('match', body => {\n        socket.broadcast.emit('match', {\n            body,\n            from: socket.decoded_token.username,\n            read: false\n        })\n    });\n    socket.on('visit', body => {\n        socket.emit('visit', {\n            body,\n            from: socket.decoded_token.username,\n            read: false\n        })\n    });\n    socket.on('disconnect', () => {\n        interactions.disconnect(socket.decoded_token.username, socket.id)\n        console.log(socket.decoded_token.username, 'disconnected on', now());\n    })\n});\n\napp.use((err, req, res, next) => {\n    if (err.name === 'UnauthorizedError') {\n        res.send({error:err.name});\n    }\n})\napp.use((req, res) =>{\n    res.type('text/html');\n    res.status(404);\n    res.send('Error 404 Page');\n})\napp.use((err, req, res) =>{\n    console.error(err.stack);\n    res.status(500);\n    res.send('Error 500 Page');\n})\nserver.listen(app.get('port'), () => {\n    console.log('Express started on http://localhost:' + app.get('port') + ' press Ctrl-C to terminate');\n})"]}